name: Compare Blocklists

on:
  workflow_run:
    workflows: ["Merge Blocklists"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write

env:
  OUTPUT_FILE: diff_from_merged.txt
  LOG_FILE: logs/compare_details.log

jobs:
  compare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: So sÃ¡nh vÃ  táº¡o danh sÃ¡ch khÃ¡c biá»‡t
        run: |
          mkdir -p logs
          echo "ðŸ“‹ So sÃ¡nh merged_blocklist.txt vÃ  my-blocklist.txt" > ${{ env.LOG_FILE }}

          if [[ -f merged_blocklist.txt && -f my-blocklist.txt ]]; then
            sort merged_blocklist.txt > sorted_merged.txt
            sort my-blocklist.txt > sorted_my.txt

            comm -23 sorted_merged.txt sorted_my.txt > ${{ env.OUTPUT_FILE }}
            COUNT=$(wc -l < ${{ env.OUTPUT_FILE }})

            echo "âœ… ÄÃ£ tÃ¬m tháº¥y $COUNT domain chá»‰ cÃ³ trong merged_blocklist.txt" | tee -a ${{ env.LOG_FILE }}
          else
            echo "âŒ Má»™t trong hai file chÆ°a tá»“n táº¡i." | tee -a ${{ env.LOG_FILE }}
            exit 1
          fi

      - name: Commit & Push káº¿t quáº£
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ${{ env.OUTPUT_FILE }} ${{ env.LOG_FILE }}
          git commit -m "ðŸ†• So sÃ¡nh & log domain khÃ¡c biá»‡t sau khi merge"
          git push || echo "âš ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘á»ƒ commit"
